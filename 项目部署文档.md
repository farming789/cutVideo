# 视频切片项目部署说明文档

## 硬件资源

## 4T西部数据红盘，共8块

- hr-s01：用于保存切片后视频，寄出七牛,已损毁
- hr-s02：用于保存源视频、音频、指纹和转码视频
- hr-s03：用于保存源视频、音频、指纹和转码视频
- hr-s04：用于保存切片后视频，寄出七牛
- hr-s05：用于保存源视频、音频、指纹和转码视频
- hr-s06：用于保存切片后视频，寄出七牛
- hr-s07：用于保存切片后视频，寄出七牛
- hr-s08：用于保存源视频、音频、指纹和转码视频

## 视频转码服务器

- 192.168.1.115，以下简称115服务器，平均处理速度6x
- 192.168.1.116，以下简称116服务器，平均处理速度6x
- 192.168.1.104，以下简称104服务器，平均处理速度4x
- 192.168.1.110，以下简称110服务器，平均处理速度4x
- 192.168.1.80， 以下简称80服务器，平均处理速度2x

## 硬盘挂载步骤

- 将1-2块用于保存切片视频的硬盘，挂载到115服务器
- 将2-3块用于保存源视频的硬盘，挂载到115服务器
- 在115服务器上启用samba网络硬盘服务

```
sudo service samba restart
```

- 在其余服务器上挂载网络硬盘，如机器因硬件故障重启，必须重新挂载。以hr-s01举例：

```
sudo mount -t cifs -o username=root,password=huanrong,gid=1000,uid=1000 //192.168.1.115/hr-s01 /mnt/hr-s01/
```

## 任务流程

- 每台机器在任意时刻运行一个实例，其实例编号在```config.json```中的schedule.instance_id定义
- pm2工具启动项目，读取```config.json```中的schedule字段定义的定时任务列表

### 抽取音频

- 开启一个定时任务
- 根据instance_id读取数据库记录
- 在源视频的硬盘的media-orign中读取待处理视频
- 抽取音频
- 提取音频指纹
- 将音频输出到同一硬盘的media-novideo文件夹下
- 将音频输出到同一硬盘的media-fingerprint文件夹下
- 结束任务

### 音频上传

- 开启一个定时任务
- 根据instance_id读取数据库记录
- 在源视频的硬盘的media-novideo文件夹读取音频或media-fingerprint文件夹音频指纹
- 上传文件
- 结束任务

### 转码

- 开启一个定时任务
- 根据instance_id读取数据库记录
- 在源视频的硬盘的media-orign中读取待处理视频
- 视频转码
- 将视频输出到同一硬盘的media-resize文件夹下
- 结束任务

### 切片

- 开启一个定时任务
- 根据instance_id读取数据库记录
- 在源视频的硬盘的media-resize中读取待处理视频
- 视频切片
- 将视频切片输出到同一硬盘的{bucket}文件夹下
- 结束任务

### 上传

- 该定时任务暂停，邮寄硬盘后手动更新记录

### 历史任务处理记录

#### instance_id对应机器列表

- 0:115
- 1:116
- 2:104
- 3:80
- 4:115
- 5:116
- 6:104
- 7:80
- 8:115
- 9:116
- 10:104
- 11:80

#### 第一阶段（项目启动至5月24号）

- 所有源文件和输出文件都在hr-s01硬盘中
- 机器实例在0、1、2、3上运行

#### 第二阶段（5月24号-5月25号18:00）

- 第一阶段的视频，音频抽取和转码工作全部完成，切片工作完成大部分
- 新的等待处理视频在hr-s02上
- 将第一阶段在hr-s01保存的音频文件和转码视频，剪切到hr-s02对应目录下
- 删除hr-s01上的源视频、音频文件和转码视频，
- 将mv_novideo表中原有的hr-s01记录刷新成hr-s02
- 将mv_resize中表中原有的hr-s01记录刷新成hr-s02
- 所有实例修改源文件、音频抽取、视频转码的路径到hr-s02硬盘相应目录，切换到4、5、6、7实例运行
- 运行一段时间后寄出hr-s01硬盘，该硬盘只包含切片文件
- 将hr-s01硬盘替换挂载到115机器的/mnt/hr-s01上继续运行执行任务

#### 第三阶段（5月25号18:00-5月28号10:00）

- 将hr-s03硬盘添加挂载到115机器的/mnt/hr-s03上
- 所有实例修改源文件、音频抽取、视频转码的路径到hr-s03硬盘相应目录，切换到8、9、10、11实例运行

#### 第四阶段（5月28号10:00-5月28号14:00）

- 所有实例修改源文件、音频抽取、视频转码的路径到hr-s02硬盘相应目录，切换到0、1、2、3实例运行

#### 第五阶段（5月28号14:00-至今）

- 更新音频上传指纹功能
- 所有实例修改源文件、音频抽取、视频转码的路径到hr-s03硬盘相应目录，切换到8、9、10、11实例运行
- 根据acrloud的反馈，将需要重新上传音频指纹的任务分配到9号实例进行


### 故障排查

- 115服务器：6月1日早重启一次，重启后因不能自动挂载硬盘，影响所有机器服务
- 116服务器：暂无问题
- 104服务器：平均每天死机两次且不能自动重启
- 80服务器：性能相对较低，6月1日早死机一次
- 110服务器：系统经常性杀死nodejs进程，平均2小时一次
