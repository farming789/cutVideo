# 切片进度跟踪文档

## 硬件资源

## 4T西部数据红盘，共8块

- hr-s01：用于保存切片后视频，寄出七牛,已损毁
- hr-s02：用于保存源视频、音频、指纹和转码视频
- hr-s03：用于保存源视频、音频、指纹和转码视频
- hr-s04：用于保存切片后视频，寄出七牛
- hr-s05：用于保存源视频、音频、指纹和转码视频
- hr-s06：用于保存切片后视频，寄出七牛
- hr-s07：用于保存切片后视频，寄出七牛
- hr-s08：用于保存源视频、音频、指纹和转码视频

## 视频转码服务器

- 192.168.1.115，以下简称115服务器，平均处理速度6x
- 192.168.1.116，以下简称116服务器，平均处理速度6x
- 192.168.1.104，以下简称104服务器，平均处理速度4x
- 192.168.1.110，以下简称110服务器，平均处理速度4x
- 192.168.1.80， 以下简称80服务器，平均处理速度2x

## 硬盘挂载步骤

- 将1-2块用于保存切片视频的硬盘，挂载到115服务器
- 将2-3块用于保存源视频的硬盘，挂载到115服务器


## 任务流程

### 准备阶段

- 在115服务器上启用samba网络硬盘服务

```
sudo service samba restart
```

- 在其余服务器上挂载网络硬盘，如机器因硬件故障重启，必须重新挂载。以hr-s01举例：

```
sudo mount -t cifs -o username=root,password=huanrong,gid=1000,uid=1000 //192.168.1.115/hr-s01 /mnt/hr-s01/
```

- 每台机器在任意时刻运行一个实例，其实例编号在```config.json```中的schedule.instance_id定义
- pm2工具启动项目，读取```config.json```中的schedule字段定义的定时任务列表

### 抽取音频

- 开启一个定时任务
- 根据instance_id读取数据库记录
- 在源视频的硬盘的media-orign中读取待处理视频
- 抽取音频
- 提取音频指纹
- 将音频输出到同一硬盘的media-novideo文件夹下
- 将音频输出到同一硬盘的media-fingerprint文件夹下
- 结束任务

### 音频上传

- 开启一个定时任务
- 根据instance_id读取数据库记录
- 在源视频的硬盘的media-novideo文件夹读取音频或media-fingerprint文件夹音频指纹
- 上传文件
- 结束任务

### 转码

- 开启一个定时任务
- 根据instance_id读取数据库记录
- 在源视频的硬盘的media-orign中读取待处理视频
- 视频转码
- 将视频输出到同一硬盘的media-resize文件夹下
- 结束任务

### 切片

- 开启一个定时任务
- 根据instance_id读取数据库记录
- 在源视频的硬盘的media-resize中读取待处理视频
- 视频切片
- 将视频切片输出到同一硬盘的{bucket}文件夹下
- 结束任务

### 上传

- 该定时任务暂停，邮寄硬盘后手动更新记录

### 批次列表

- v1:05月18日添加，共45个文件
- v2:05月19日添加，共442个文件
- v3:05月23日添加，共716个文件
- v4:05月23日添加，共351个文件
- v5:05月24日添加，共468个文件
- v6:05月26日添加，共2487个文件
- v7:06月01日添加，共1000个文件
- v8:06月05日添加，共1538个文件
- v9:06月08日添加，共1463个文件
- v10:06月14日添加，共1306个文件
- v11:06月19日添加，共2384个文件
- v12:06月25日添加，共2004个文件
- v13:06月28日添加，共1275个文件

### 进度跟踪

- 115:08硬盘/v12批次
- 116:03硬盘/v12批次
- 80 :05硬盘/v11批次
- 106:03硬盘/v12批次
- 110:03硬盘/v13批次

### 上线更新计划

- 07月09日提交iOS审核，计划更新到v11批次中包含视频
